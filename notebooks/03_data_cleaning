from sklearn.preprocessing import LabelEncoder
import pandas as pd

def preprocess_data(df):
    
    df_clean = df.copy()
    
    # 1. Remover ID
    df_clean.drop('customerID', axis=1, inplace=True)
    
    # 2. Tratamento coluna de Cobranças totais
    df_clean['TotalCharges'] = pd.to_numeric(df_clean['TotalCharges'], errors='coerce')
    nulos_count = df_clean['TotalCharges'].isnull().sum()
    print(f"Valores nulos em TotalCharges: {nulos_count}")
    df_clean['TotalCharges'] = df_clean['TotalCharges'].fillna(df_clean['TotalCharges'].median())
    
    # 3. Separar variáveis
    categorical_cols = df_clean.select_dtypes(include=['object']).columns
    
    # 4. Aplicar encoding binário
    binary_cols = []
    multi_cols = []
    
    for col in categorical_cols:
        if col != 'Churn':  # Excluir target
            if df_clean[col].nunique() == 2:
                binary_cols.append(col)
            else:
                multi_cols.append(col)
  
    le = LabelEncoder()
    for col in binary_cols:
        df_clean[col] = le.fit_transform(df_clean[col])
    
    # 5. One-hot encoding
    if multi_cols:  # Só executa se houver colunas múltiplas
        df_clean = pd.get_dummies(df_clean, columns=multi_cols, drop_first=True)
    
    # 6. Encoding do target (Churn)
    df_clean['Churn'] = le.fit_transform(df_clean['Churn'])
    
    print(f"\nPré-processamento concluído!")
    print(f"Shape final: {df_clean.shape}")
    print(f"Tipos de dados:\n{df_clean.dtypes.value_counts()}")
    
    return df_clean

# Usar a função corrigida
df_processed = preprocess_data(df)
